<!DOCTYPE html>
<html lang="en-us">
    <head><script src="/livereload.js?port=1313&amp;mindelay=10&amp;v=2" data-no-instant defer></script><meta charset='utf-8'>
<meta name='viewport' content='width=device-width, initial-scale=1'><meta name='description' content='HackLu CTF 2018'><title>HackLu 2018 - Forgetful Commander</title>

<link rel='canonical' href='http://localhost:1313/post/hacklu-2018-forgetful-commander/'>

<link rel="stylesheet" href="/scss/style.min.css"><meta property='og:title' content='HackLu 2018 - Forgetful Commander'>
<meta property='og:description' content='HackLu CTF 2018'>
<meta property='og:url' content='http://localhost:1313/post/hacklu-2018-forgetful-commander/'>
<meta property='og:site_name' content='x0r19x91&#39;s blog'>
<meta property='og:type' content='article'><meta property='article:section' content='Post' /><meta property='article:tag' content='ctf' /><meta property='article:tag' content='reversing' /><meta property='article:published_time' content='2018-10-19T00:00:00&#43;05:30'/><meta property='article:modified_time' content='2018-10-19T00:00:00&#43;05:30'/>
<meta name="twitter:title" content="HackLu 2018 - Forgetful Commander">
<meta name="twitter:description" content="HackLu CTF 2018">
    </head>
    <body class="">
        <div class="container flex on-phone--column align-items--flex-start extended article-page with-toolbar">
            <aside class="sidebar left-sidebar sticky">
    <button class="hamburger hamburger--spin" type="button" id="toggle-menu" aria-label="Toggle Menu">
        <span class="hamburger-box">
            <span class="hamburger-inner"></span>
        </span>
    </button>

    <header class="site-info">
        
            <figure class="site-avatar">
                

                
                    
                    <img src="/img/avatar_huda2458f72ce188392d75c5d51cd8e24e_373_300x300_resize_box_2.png" width="300"
                        height="300" class="site-logo" loading="lazy" alt="Avatar">
                

                
                    <span class="emoji">üç•</span>
                
            </figure>
        
        <h1 class="site-name"><a href="http://localhost:1313/">x0r19x91&#39;s blog</a></h1>
        <h2 class="site-description">My little corner in the web</h2>
    </header>

    <ol class="menu" id="main-menu">
        
        
        

        <li >
            <a href='/'>
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <polyline points="5 12 3 12 12 3 21 12 19 12" />
  <path d="M5 12v7a2 2 0 0 0 2 2h10a2 2 0 0 0 2 -2v-7" />
  <path d="M9 21v-6a2 2 0 0 1 2 -2h2a2 2 0 0 1 2 2v6" />
</svg>



                
                <span>Home</span>
            </a>
        </li>
        
        

        <li >
            <a href='/about'>
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-user" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="7" r="4" />
  <path d="M6 21v-2a4 4 0 0 1 4 -4h4a4 4 0 0 1 4 4v2" />
</svg>



                
                <span>About</span>
            </a>
        </li>
        
        

        <li >
            <a href='/archives'>
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <rect x="3" y="4" width="18" height="4" rx="2" />
  <path d="M5 8v10a2 2 0 0 0 2 2h10a2 2 0 0 0 2 -2v-10" />
  <line x1="10" y1="12" x2="14" y2="12" />
</svg>



                
                <span>Archives</span>
            </a>
        </li>
        
        

        <li >
            <a href='/search'>
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="10" cy="10" r="7" />
  <line x1="21" y1="21" x2="15" y2="15" />
</svg>



                
                <span>Search</span>
            </a>
        </li>
        
    </ol>
</aside>

            <main class="main full-width">
    <div id="article-toolbar">
        <a href="http://localhost:1313/" class="back-home">
            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-chevron-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <polyline points="15 6 9 12 15 18" />
</svg>



            <span>Back</span>
        </a>
    </div>

    <article class="main-article">
    <header class="article-header">

    <div class="article-details">
    
    <header class="article-category">
        
            
                <a href="/categories/ctf/">ctf</a>
            
        
            
                <a href="/categories/reversing/">reversing</a>
            
        
    </header>
    

    <h2 class="article-title">
        <a href="/post/hacklu-2018-forgetful-commander/">HackLu 2018 - Forgetful Commander</a>
    </h2>

    
    <h3 class="article-subtitle">
        HackLu CTF 2018
    </h3>
    <footer class="article-time">
        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="12" r="9" />
  <polyline points="12 7 12 12 15 15" />
</svg>



        <time class="article-time--published">Oct 19, 2018</time>
    </footer></div>
</header>

    <section class="article-content">
    <p>I&rsquo;ll do static analysis using radare.</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">    ‚îå‚îÄ[x0r19x91@x0r19x91]‚îÄ[~/Desktop/ctf/hacklu/ForgetfulCommander/public]
    ‚îî‚îÄ‚îÄ‚ïº $ objdump -d -M intel -j.text forgetful_commander

    forgetful_commander:     file format elf32-i386

    Disassembly of section .text:

    <span style="color:#3677a9">00002050</span> &lt;.text&gt;:
        2050:       <span style="color:#3677a9">99</span>                      cdq    
        2051:       <span style="color:#3677a9">67</span> <span style="color:#24909d">cd</span> <span style="color:#3677a9">30</span>                addr16 int 0x30
        2054:       a5                      movs   DWORD PTR es:[edi],DWORD PTR ds:[esi]
        2055:       <span style="color:#3677a9">02</span> <span style="color:#24909d">fc</span>                   add    bh,ah
        ...
</code></pre></div><p>Ahh ! So we have garbage in .text. Fire up radare :-)</p>
<pre><code class="language-x86asm" data-lang="x86asm">    0x0000d000      50             push eax
    0x0000d001      60             pushal
    0x0000d002      9c             pushfd
    0x0000d003      81ec00500000   sub esp, 0x5000
    0x0000d009      b855000000     mov eax, 0x55               ; 'U'
    0x0000d00e      6878650000     push 0x6578                 ; 'xe'
    0x0000d013      686c662f65     push 0x652f666c             ; 'lf/e'
    0x0000d018      68632f7365     push 0x65732f63             ; 'c/se'
    0x0000d01d      682f70726f     push 0x6f72702f             ; '/pro'
    0x0000d022      89e3           mov ebx, esp
    0x0000d024      8d8c24104000.  lea ecx, [arg_4010h]        ; 0x4010
    0x0000d02b      baff0f0000     mov edx, 0xfff
    ;-- syscall.readlink:
    0x0000d030      cd80           int 0x80
    0x0000d032      83c410         add esp, 0x10
    0x0000d035      83f800         cmp eax, 0
    0x0000d038      0f8e92010000   jle 0xd1d0
    0x0000d03e      89c7           mov edi, eax
    0x0000d040      8d8c04004000.  lea ecx, [esp + eax + 0x4000]
    0x0000d047      c6010a         mov byte [ecx], 0xa
    0x0000d04a      47             inc edi
    0x0000d04b      b805000000     mov eax, 5
    0x0000d050      6861707300     push 0x737061               ; 'aps'
    0x0000d055      686c662f6d     push 0x6d2f666c             ; 'lf/m'
    0x0000d05a      68632f7365     push 0x65732f63             ; 'c/se'
    0x0000d05f      682f70726f     push 0x6f72702f             ; '/pro'
    0x0000d064      89e3           mov ebx, esp
    0x0000d066      31c9           xor ecx, ecx
    ;-- syscall.open:
    0x0000d068      cd80           int 0x80
    0x0000d06a      83c410         add esp, 0x10
    0x0000d06d      83f800         cmp eax, 0
    0x0000d070      0f8c5a010000   jl 0xd1d0
    0x0000d076      89c6           mov esi, eax
</code></pre><p>So, the program reads the path of its executable, i.e., the path for &lsquo;forgetful_commander&rsquo; using <strong>sys_readlink</strong> and opens the file <strong>'/proc/self/maps'</strong></p>
<pre><code class="language-x86asm" data-lang="x86asm">    0x0000d078      b803000000     mov eax, 3
    0x0000d07d      89f3           mov ebx, esi
    0x0000d07f      89e1           mov ecx, esp
    0x0000d081      ba00400000     mov edx, 0x4000
    ;-- syscall.read:
    0x0000d086      cd80           int 0x80
    0x0000d088      83f800         cmp eax, 0
    0x0000d08b      0f8ee9000000   jle 0xd17a
    0x0000d091      31c9           xor ecx, ecx
    0x0000d093      31d2           xor edx, edx
    0x0000d095      bd01000000     mov ebp, 1   ; flag for breaking loop
    ; CODE XREFS from entry0 (0xd0b7, 0xd0c6)
    0x0000d09a      39c1           cmp ecx, eax
    0x0000d09c      0f8d29000000   jge 0xd0cb
    0x0000d0a2      0fb61c0c       movzx ebx, byte [esp + ecx]
    0x0000d0a6      41             inc ecx
    0x0000d0a7      389c14004000.  cmp byte [esp + edx + 0x4000], bl
    0x0000d0ae      0f8510000000   jne 0xd0c4
    0x0000d0b4      42             inc edx
    0x0000d0b5      39fa           cmp edx, edi
    0x0000d0b7      0f85ddffffff   jne 0xd09a
    0x0000d0bd      31ed           xor ebp, ebp
    0x0000d0bf      e907000000     jmp 0xd0cb
    ; CODE XREF from entry0 (0xd0ae)
    0x0000d0c4      31d2           xor edx, edx
    0x0000d0c6      e9cfffffff     jmp 0xd09a
    ; CODE XREFS from entry0 (0xd09c, 0xd0bf)
    0x0000d0cb      85ed           test ebp, ebp
    0x0000d0cd      0f85a5ffffff   jne 0xd078
</code></pre><p>Here we have a loop which reads a block of 16K bytes and searches for the path to its executable followed by a newline. The loop breaks when <strong>ecx</strong> is the offset of the newline in the string.</p>
<pre><code class="language-x86asm" data-lang="x86asm">    0x0000d0d3      31db           xor ebx, ebx
    0x0000d0d5      49             dec ecx
    0x0000d0d6      83f900         cmp ecx, 0
    0x0000d0d9      0f9fc3         setg bl
    0x0000d0dc      807c0cff0a     cmp byte [esp + ecx - 1], 0xa ; prev newline
    0x0000d0e1      0f95c7         setne bh
    0x0000d0e4      84fb           test bl, bh
    0x0000d0e6      0f85e7ffffff   jne 0xd0d3
</code></pre><p>This loop searches for the offset of the previous newline and breaks when <strong>ecx</strong> points to the beginning of line containing the executable path.</p>
<pre><code class="language-x86asm" data-lang="x86asm">    0x0000d0ec      31d2           xor edx, edx
    0x0000d0ee      89cd           mov ebp, ecx
    0x0000d0f0      83c108         add ecx, 8   ; 32bit address
    ; CODE XREFS from entry0 (0xd118, 0xd140, 0xd168)
    0x0000d0f3      39cd           cmp ebp, ecx
    0x0000d0f5      0f8d7f000000   jge 0xd17a
    0x0000d0fb      c1c204         rol edx, 4
    0x0000d0fe      31db           xor ebx, ebx
    0x0000d100      803c2c30       cmp byte [esp + ebp], 0x30  ; '0'
    0x0000d104      0f9dc3         setge bl
    0x0000d107      803c2c39       cmp byte [esp + ebp], 0x39  ; '9'
    0x0000d10b      0f9ec7         setle bh
    0x0000d10e      802c2c30       sub byte [esp + ebp], 0x30  ; '0'
    0x0000d112      32142c         xor dl, byte [esp + ebp]
    0x0000d115      45             inc ebp
    0x0000d116      84fb           test bl, bh
    0x0000d118      0f85d5ffffff   jne 0xd0f3
    0x0000d11e      4d             dec ebp
    0x0000d11f      32142c         xor dl, byte [esp + ebp]
    0x0000d122      80042c30       add byte [esp + ebp], 0x30  ; '0'
    0x0000d126      31db           xor ebx, ebx
    0x0000d128      803c2c61       cmp byte [esp + ebp], 0x61  ; 'a'
    0x0000d12c      0f9dc3         setge bl
    0x0000d12f      803c2c7a       cmp byte [esp + ebp], 0x7a  ; 'z'
    0x0000d133      0f9ec7         setle bh
    0x0000d136      802c2c57       sub byte [esp + ebp], 0x57  ; 'W'
    0x0000d13a      32142c         xor dl, byte [esp + ebp]
    0x0000d13d      45             inc ebp
    0x0000d13e      84fb           test bl, bh
    0x0000d140      0f85adffffff   jne 0xd0f3
    0x0000d146      4d             dec ebp
    0x0000d147      32142c         xor dl, byte [esp + ebp]
    0x0000d14a      80042c61       add byte [esp + ebp], 0x61  ; 'a'
    0x0000d14e      31db           xor ebx, ebx
    0x0000d150      803c2c41       cmp byte [esp + ebp], 0x41  ; 'A'
    0x0000d154      0f9dc3         setge bl
    0x0000d157      803c2c5a       cmp byte [esp + ebp], 0x5a  ; 'Z'
    0x0000d15b      0f9ec7         setle bh
    0x0000d15e      802c2c37       sub byte [esp + ebp], 0x37  ; '7'
    0x0000d162      32142c         xor dl, byte [esp + ebp]
    0x0000d165      45             inc ebp
    0x0000d166      84fb           test bl, bh
    0x0000d168      0f8585ffffff   jne 0xd0f3
</code></pre><p>This loop parses the address pointed to by <strong>ecx</strong> into <strong>edx</strong>. The base address of the map</p>
<pre><code class="language-x86asm" data-lang="x86asm">    0x0000d183      85d2           test edx, edx
    0x0000d185      0f8445000000   je 0xd1d0
    0x0000d18b      81c250200000   add edx, 0x2050
    0x0000d191      899424245000.  mov dword [arg_5024h], edx ; return addr
    0x0000d198      83ea50         sub edx, 0x50
    0x0000d19b      89c5           mov ebp, eax     ; eax = 0
    0x0000d19d      40             inc eax
    0x0000d19e      40             inc eax
    ; CODE XREF from entry0 (0xd1c2)
    0x0000d19f      be78756c46     mov esi, 0x466c7578         ; 'xulF'
    0x0000d1a4      31db           xor ebx, ebx
    0x0000d1a6      39e8           cmp eax, ebp
    0x0000d1a8      0f8419000000   je 0xd1c7
    0x0000d1ae      b900040000     mov ecx, 0x400
    ; CODE XREF from entry0 (0xd1bf)
    0x0000d1b3      311a           xor dword [edx], ebx
    0x0000d1b5      3132           xor dword [edx], esi
    0x0000d1b7      c1ce08         ror esi, 8
    0x0000d1ba      8b1a           mov ebx, dword [edx]
    0x0000d1bc      83c204         add edx, 4
    0x0000d1bf      e2f2           loop 0xd1b3
    0x0000d1c1      48             dec eax
    0x0000d1c2      e9d8ffffff     jmp 0xd19f
</code></pre><p>Return address is <strong>edx+0x2050</strong>. This loop decrypts the 2*4K bytes or 2 pages mapped from 0x2000 and then jumps to <strong>edx+0x2050</strong>.</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">    ‚îå‚îÄ[x0r19x91@x0r19x91]‚îÄ[~/Desktop/ctf/hacklu/ForgetfulCommander/public]                                                                                                                                                                       
    ‚îî‚îÄ‚îÄ‚ïº $ readelf --program-headers forgetful_commander

    Elf file <span style="color:#24909d">type</span> is DYN (Shared object file)
    Entry point 0xd000
    There are <span style="color:#3677a9">12</span> program headers, starting at offset <span style="color:#3677a9">52</span>

    Program Headers:
      Type           Offset   VirtAddr   PhysAddr   FileSiz MemSiz  Flg Align
      ...
      LOAD           0x002000 0x00002000 0x00002000 0x00338 0x00338 RWE 0x1000
      LOAD           0x003000 0x00003000 0x00003000 0x004f0 0x004f0 RW  0x1000
      ...
</code></pre></div><p>So we need to decrypt <strong>0x338 bytes</strong> at <strong>offset 0x2000</strong> and <strong>0x4f0 bytes</strong> at <strong>offset 0x3000</strong></p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c">    <span style="color:#cd2828;font-weight:bold">#include</span> <span style="color:#cd2828;font-weight:bold">&lt;stdio.h&gt;</span><span style="color:#cd2828;font-weight:bold">
</span><span style="color:#cd2828;font-weight:bold"></span>    <span style="color:#cd2828;font-weight:bold">#include</span> <span style="color:#cd2828;font-weight:bold">&lt;sys/types.h&gt;</span><span style="color:#cd2828;font-weight:bold">
</span><span style="color:#cd2828;font-weight:bold"></span>    <span style="color:#cd2828;font-weight:bold">#include</span> <span style="color:#cd2828;font-weight:bold">&lt;unistd.h&gt;</span><span style="color:#cd2828;font-weight:bold">
</span><span style="color:#cd2828;font-weight:bold"></span>    <span style="color:#cd2828;font-weight:bold">#include</span> <span style="color:#cd2828;font-weight:bold">&lt;sys/mman.h&gt;</span><span style="color:#cd2828;font-weight:bold">
</span><span style="color:#cd2828;font-weight:bold"></span>    <span style="color:#cd2828;font-weight:bold">#include</span> <span style="color:#cd2828;font-weight:bold">&lt;stdlib.h&gt;</span><span style="color:#cd2828;font-weight:bold">
</span><span style="color:#cd2828;font-weight:bold"></span>    <span style="color:#cd2828;font-weight:bold">#include</span> <span style="color:#cd2828;font-weight:bold">&lt;fcntl.h&gt;</span><span style="color:#cd2828;font-weight:bold">
</span><span style="color:#cd2828;font-weight:bold"></span>    <span style="color:#cd2828;font-weight:bold">#include</span> <span style="color:#cd2828;font-weight:bold">&lt;sys/stat.h&gt;</span><span style="color:#cd2828;font-weight:bold">
</span><span style="color:#cd2828;font-weight:bold"></span>    <span style="color:#cd2828;font-weight:bold">#include</span> <span style="color:#cd2828;font-weight:bold">&lt;stdint.h&gt;</span><span style="color:#cd2828;font-weight:bold">
</span><span style="color:#cd2828;font-weight:bold"></span>    <span style="color:#cd2828;font-weight:bold">#include</span> <span style="color:#cd2828;font-weight:bold">&lt;string.h&gt;</span><span style="color:#cd2828;font-weight:bold">
</span><span style="color:#cd2828;font-weight:bold"></span>
    <span style="color:#6ab825;font-weight:bold">void</span> <span style="color:#447fcf">decrypt</span>(<span style="color:#6ab825;font-weight:bold">char</span>* base, size_t size)
    {
        uint32_t* addr = (uint32_t*) mem;
        uint32_t k = <span style="color:#3677a9">0</span>;
        uint32_t u = <span style="color:#a61717;background-color:#e3d2d2">&#39;</span>Flux<span style="color:#a61717;background-color:#e3d2d2">&#39;</span>;
        size &gt;&gt;= <span style="color:#3677a9">2</span>;
        <span style="color:#6ab825;font-weight:bold">for</span> (<span style="color:#6ab825;font-weight:bold">int</span> j = <span style="color:#3677a9">0</span>; j &lt; size; ++j) {
            *addr ^= k^u;
            <span style="color:#6ab825;font-weight:bold">asm</span> <span style="color:#6ab825;font-weight:bold">volatile</span> (<span style="color:#ed9d13">&#34;rorl $8, %0&#34;</span> :: <span style="color:#ed9d13">&#34;m&#34;</span>(u));
            k = *addr++;
        }
    }

    <span style="color:#6ab825;font-weight:bold">int</span> <span style="color:#447fcf">main</span>()
    {
        <span style="color:#6ab825;font-weight:bold">int</span> file = open(<span style="color:#ed9d13">&#34;forgetful_commander&#34;</span>, <span style="color:#3677a9">0</span>);
        <span style="color:#6ab825;font-weight:bold">int</span> file_size = <span style="color:#3677a9">0x338</span> &gt;&gt; <span style="color:#3677a9">2</span>;
        <span style="color:#6ab825;font-weight:bold">struct</span> stat sBuf;
        fstat(file, &amp;sBuf);
        <span style="color:#6ab825;font-weight:bold">char</span>* mem = mmap(<span style="color:#3677a9">0</span>, sBuf.st_size, PROT_READ|PROT_WRITE, MAP_PRIVATE, file, <span style="color:#3677a9">0</span>);
        decrypt(mem+<span style="color:#3677a9">0x2000</span>, <span style="color:#3677a9">0x338</span>);
        decrypt(mem+<span style="color:#3677a9">0x3000</span>, <span style="color:#3677a9">0x4f0</span>);
        <span style="color:#6ab825;font-weight:bold">int</span> outfile = open(<span style="color:#ed9d13">&#34;forgetful&#34;</span>, O_WRONLY|O_CREAT|O_TRUNC, <span style="color:#3677a9">0777</span>);
        write(outfile, mem, sBuf.st_size);
        munmap(mem, sBuf.st_size);
        close(outfile);
        close(file);
    }
</code></pre></div><p>Now lets open &lsquo;forgetful&rsquo; in radare and disassemble at offset 0x2050.</p>
<pre><code class="language-x86asm" data-lang="x86asm">    ;-- section..text:
    0x00002050      31ed           xor ebp, ebp
    0x00002052      5e             pop esi
    0x00002053      89e1           mov ecx, esp
    0x00002055      83e4f0         and esp, 0xfffffff0
    0x00002058      50             push eax
    0x00002059      54             push esp
    0x0000205a      52             push edx
    0x0000205b      e822000000     call __pc_thunk_bx
    0x00002060      81c3a02f0000   add ebx, 0x2fa0
    0x00002066      8d8320d3ffff   lea eax, [ebx - 0x2ce0]
    0x0000206c      50             push eax
    0x0000206d      8d83c0d2ffff   lea eax, [ebx - 0x2d40]
    0x00002073      50             push eax
    0x00002074      51             push ecx
    0x00002075      56             push esi
    0x00002076      ffb3f8ffffff   push dword [ebx - 8] ; 0x2190
    0x0000207c      e8bfffffff     call sym.imp.__libc_start_main
    0x00002081      f4             hlt
</code></pre><p>Great ! This is the new entry point. Lets move on to <strong>main</strong> which is at offset 0x2190</p>
<pre><code class="language-x86asm" data-lang="x86asm">    0x00002190      55             push ebp
    0x00002191      89e5           mov ebp, esp
    0x00002193      53             push ebx
    0x00002194      57             push edi
    0x00002195      56             push esi
    0x00002196      83ec2c         sub esp, 0x2c            ; ','
    0x00002199      e800000000     call __get_pc_thunk_ebx
    0x0000219e      58             pop eax
    0x0000219f      81c0622e0000   add eax, 0x2e62          ; eax = 0x5000
    0x000021a5      8b4d0c         mov ecx, dword [arg_ch]  ; argv
    0x000021a8      8b5508         mov edx, dword [arg_8h]  ; argc
    0x000021ab      c745f0000000.  mov dword [local_10h], 0
    0x000021b2      837d0802       cmp dword [arg_8h], 2
    0x000021b6      8945d8         mov dword [local_28h], eax
    0x000021b9      894dd4         mov dword [local_2ch], ecx
    0x000021bc      8955d0         mov dword [local_30h], edx
    0x000021bf      0f840c000000   je 0x21d1
    0x000021c5      c745f0010000.  mov dword [local_10h], 1 ; exit code
    0x000021cc      e9d7000000     jmp 0x22a8
</code></pre><p>So we need to pass 2 arguments to the commander. Lets to to 0x21d1&hellip;</p>
<pre><code class="language-x86asm" data-lang="x86asm">    0x000021d1      c745ec000000.  mov dword [local_14h], 0
    0x000021d8      c745e8050000.  mov dword [local_18h], 5
    0x000021df      c745e4050000.  mov dword [local_1ch], 5
    0x000021e6      c745e0000000.  mov dword [local_20h], 0

    0x000021ed      8b45e0         mov eax, dword [local_20h]   ; loop counter
    0x000021f0      8b4d0c         mov ecx, dword [arg_ch]
    0x000021f3      8b4904         mov ecx, dword [ecx + 4]
    0x000021f6      89e2           mov edx, esp
    0x000021f8      890a           mov dword [edx], ecx
    0x000021fa      8b5dd8         mov ebx, dword [local_28h]
    0x000021fd      8945cc         mov dword [local_34h], eax
    0x00002200      e82bfeffff     call sym.imp.strlen
    0x00002205      8b4dcc         mov ecx, dword [local_34h]
    0x00002208      39c1           cmp ecx, eax
    ; local_20h &lt; len(argv[1])
    0x0000220a      0f837b000000   jae 0x228b

    0x00002210      8b450c         mov eax, dword [arg_ch]
    0x00002213      8b4004         mov eax, dword [eax + 4]
    0x00002216      8b4de0         mov ecx, dword [local_20h]
    0x00002219      8a1408         mov dl, byte [eax + ecx]
    0x0000221c      8855df         mov byte [local_21h], dl     ; argv[1][local_20h]
    0x0000221f      8b45e8         mov eax, dword [local_18h]
</code></pre><p>Here&rsquo;s some anti-debugging code</p>
<pre><code class="language-x86asm" data-lang="x86asm">    0x00002222      9c             pushfd
    0x00002223      5a             pop edx
    0x00002224      89d1           mov ecx, edx
    0x00002226      81e100010000   and ecx, 0x100   ; EFLAGS.Trap

    ; Clear EFLAGS.Trap from edx
    0x0000222c      31ca           xor edx, ecx

    ; Copy EFLAGS.Trap to EFLAGS.ZeroFlag
    0x0000222e      c1c902         ror ecx, 2
    0x00002231      31ca           xor edx, ecx

    0x00002233      52             push edx
    0x00002234      89c2           mov edx, eax
    0x00002236      9d             popfd

    ; ecx = 0x100 &gt;&gt; 2 i.e. 0x40 if EFLAGS.Trap is set
    0x00002237      0f44d1         cmove edx, ecx
    0x0000223a      89d0           mov eax, edx
    0x0000223c      8945e8         mov dword [local_18h], eax
</code></pre><p>So, <strong>local_18h</strong> is 0x40 if <strong>EFLAGS.Trap</strong> is set otherwise 0x05</p>
<pre><code class="language-x86asm" data-lang="x86asm">    0x0000223f      0fbe45df       movsx eax, byte [local_21h]
    0x00002243      8b4de0         mov ecx, dword [local_20h]
    0x00002246      8b75d8         mov esi, dword [local_28h]   ; offset 0x5000
    0x00002249      0fbe8c0ef1e3.  movsx ecx, byte [esi + ecx - 0x1c0f]
    0x00002251      8b7de8         mov edi, dword [local_18h]
    0x00002254      8b5de0         mov ebx, dword [local_20h]
    0x00002257      0faf5de4       imul ebx, dword [local_1ch]
    0x0000225b      01df           add edi, ebx
    0x0000225d      0fbebc3e08e0.  movsx edi, byte [esi + edi - 0x1ff8]
    0x00002265      31f9           xor ecx, edi
    0x00002267      39c8           cmp eax, ecx
    0x00002269      0f8509000000   jne 0x2278
    0x0000226f      8b45ec         mov eax, dword [local_14h]
    0x00002272      83c001         add eax, 1
    0x00002275      8945ec         mov dword [local_14h], eax
    ; CODE XREF from sub.strlen_19e (0x2269)
    0x00002278      e900000000     jmp 0x227d
    ; CODE XREF from sub.strlen_19e (0x2278)
    0x0000227d      8b45e0         mov eax, dword [local_20h]
    0x00002280      83c001         add eax, 1
    0x00002283      8945e0         mov dword [local_20h], eax
    0x00002286      e962ffffff     jmp 0x21ed
</code></pre><p>Okay, this is a simple validation loop</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">    m = <span style="color:#3677a9">5</span>
    <span style="color:#6ab825;font-weight:bold">if</span> debugging:
        m = <span style="color:#3677a9">0x40</span>
    <span style="color:#6ab825;font-weight:bold">for</span> i <span style="color:#6ab825;font-weight:bold">in</span> <span style="color:#24909d">xrange</span>(<span style="color:#24909d">len</span>(sys.argv[<span style="color:#3677a9">1</span>])):
        argv[<span style="color:#3677a9">1</span>][i] == ((base+<span style="color:#3677a9">0x3008</span>)[<span style="color:#3677a9">5</span>*i+m] ^ (base+<span style="color:#3677a9">0x33f1</span>)[i])
</code></pre></div><div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">    <span style="color:#a61717;background-color:#e3d2d2">‚îå‚îÄ</span>[x0r19x91<span style="color:#ffa500">@x0r19x91</span>]<span style="color:#a61717;background-color:#e3d2d2">‚îÄ</span>[~/Desktop/ctf/hacklu/ForgetfulCommander/public]
    <span style="color:#a61717;background-color:#e3d2d2">‚îî‚îÄ‚îÄ‚ïº</span> <span style="color:#a61717;background-color:#e3d2d2">$</span> cat solve.py
    <span style="color:#999;font-style:italic">#!/usr/bin/env python</span>

    <span style="color:#6ab825;font-weight:bold">def</span> <span style="color:#447fcf">getFlag</span>(text, size, isDebugging=False):
        ans = <span style="color:#ed9d13">&#39;&#39;</span>
        delta = <span style="color:#3677a9">5</span> + <span style="color:#3677a9">0x3b</span>*isDebugging
        <span style="color:#6ab825;font-weight:bold">for</span> i <span style="color:#6ab825;font-weight:bold">in</span> <span style="color:#24909d">xrange</span>(size):
            ans += <span style="color:#24909d">chr</span>(<span style="color:#24909d">ord</span>(text[<span style="color:#3677a9">5</span>*i+delta+<span style="color:#3677a9">0x3008</span>])^<span style="color:#24909d">ord</span>(text[i+<span style="color:#3677a9">0x33f1</span>]))
        <span style="color:#6ab825;font-weight:bold">return</span> ans

    <span style="color:#6ab825;font-weight:bold">with</span> <span style="color:#24909d">open</span>(<span style="color:#ed9d13">&#39;forgetful&#39;</span>, <span style="color:#ed9d13">&#39;rb&#39;</span>) <span style="color:#6ab825;font-weight:bold">as</span> f:
        data = f.read()
        <span style="color:#6ab825;font-weight:bold">print</span> <span style="color:#ed9d13">&#39;[*] Flag -&#39;</span>, getFlag(data, <span style="color:#3677a9">58</span>)
        <span style="color:#999;font-style:italic"># if we have the trap flag set, we get</span>
        <span style="color:#6ab825;font-weight:bold">print</span> <span style="color:#ed9d13">&#39;[*] Fake Flag -&#39;</span>, getFlag(data, <span style="color:#3677a9">58</span>, True)

    <span style="color:#a61717;background-color:#e3d2d2">‚îå‚îÄ</span>[x0r19x91<span style="color:#ffa500">@x0r19x91</span>]<span style="color:#a61717;background-color:#e3d2d2">‚îÄ</span>[~/Desktop/ctf/hacklu/ForgetfulCommander/public]
    <span style="color:#a61717;background-color:#e3d2d2">‚îî‚îÄ‚îÄ‚ïº</span> <span style="color:#a61717;background-color:#e3d2d2">$</span> python solve.py
    [*] Flag - flag{Just_type__Please__and_the_missles_will_be_launched.}
    [*] Fake Flag - This_is_not_the_flag._Tough_luck..........................
</code></pre></div><p>Yay !!</p>
</section>


    <footer class="article-footer">
    
    <section class="article-tags">
        
            <a href="/tags/ctf/">ctf</a>
        
            <a href="/tags/reversing/">reversing</a>
        
    </section>


    
    <section class="article-copyright">
        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="12" r="9" />
  <path d="M14.5 9a3.5 4 0 1 0 0 6" />
</svg>



        <span>Licensed under CC BY-NC-SA 4.0</span>
    </section>
    </footer>

    
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css"
    integrity="sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3+Aro6EYUG4+cU+KJWu/X" crossorigin="anonymous">
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.js"
    integrity="sha384-g7c+Jr9ZivxKLnZTDUhnkOnsh30B4H0rpLUpJ4jAIKs4fnJI+sEnkvrMWph2EDg4"
    crossorigin="anonymous"></script>
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/contrib/auto-render.min.js"
    integrity="sha384-mll67QQFJfxn0IYznZYonOWZ644AWYC+Pt2cHqMaRhXVrursRwvLnLaebdGIlYNa" crossorigin="anonymous"
    onload="renderMathInElement(document.querySelector(`.article-content`));"></script>
    
</article>

    <aside class="related-contents--wrapper">
    
    
        <h2 class="section-title">Related contents</h2>
        <div class="related-contents">
            <div class="flex article-list--tile">
                
                    
<article class="">
    <a href="/post/inctf-2018-decoy/">
        
        

        <div class="article-details">
            <h2 class="article-title">InCTF 2018 - Decoy</h2>
        </div>
    </a>
</article>
                
                    
<article class="">
    <a href="/post/inctf-2018-ultimate-goal/">
        
        

        <div class="article-details">
            <h2 class="article-title">InCTF 2018 - Ultimate GOal</h2>
        </div>
    </a>
</article>
                
                    
<article class="">
    <a href="/post/inctf-2018-mast3r/">
        
        

        <div class="article-details">
            <h2 class="article-title">InCTF 2018 - mast3r</h2>
        </div>
    </a>
</article>
                
                    
<article class="">
    <a href="/post/inctf-confuse-me/">
        
        

        <div class="article-details">
            <h2 class="article-title">INCTF - Confuse Me</h2>
        </div>
    </a>
</article>
                
                    
<article class="">
    <a href="/post/bsides-ctf-2019-opendoor/">
        
        

        <div class="article-details">
            <h2 class="article-title">BSides CTF 2019 - opendoor</h2>
        </div>
    </a>
</article>
                
            </div>
        </div>
    
</aside>


    
        
    

    <footer class="site-footer">
    <section class="copyright">&copy; 2020 x0r19x91&#39;s blog</section>
    <section class="powerby">
        Built with <a href="https://gohugo.io/" target="_blank" rel="noopener">Hugo</a> <br />
        Theme <b><a href="https://github.com/CaiJimmy/hugo-theme-stack" target="_blank" rel="noopener" data-version="1.1.0">Stack</a></b> designed by
        <a href="https://jimmycai.com" target="_blank" rel="noopener">Jimmy</a>
    </section>
</footer>
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true" style="display:none">

    
    <div class="pswp__bg"></div>

    
    <div class="pswp__scroll-wrap">

        
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>

        
        <div class="pswp__ui pswp__ui--hidden">

            <div class="pswp__top-bar">

                

                <div class="pswp__counter"></div>

                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>

                <button class="pswp__button pswp__button--share" title="Share"></button>

                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>

                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>

                
                
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                        <div class="pswp__preloader__cut">
                            <div class="pswp__preloader__donut"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div>
            </div>

            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>

            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>

            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>

        </div>

    </div>

</div>
            </main>
        </div>
        <script src="https://cdn.jsdelivr.net/npm/node-vibrant@3.1.5/dist/vibrant.min.js"
    integrity="sha256-5NovOZc4iwiAWTYIFiIM7DxKUXKWvpVEuMEPLzcm5/g=" crossorigin="anonymous"></script><script type="text/javascript" src="/ts/main.js" defer></script>
<script>
    (function () {
        const customFont = document.createElement('link');
        customFont.href = "https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap";

        customFont.type = "text/css";
        customFont.rel = "stylesheet";

        document.head.appendChild(customFont);
    }());
</script>
<link rel="stylesheet" href="/css/highlight/light.min.css" media="(prefers-color-scheme: light)">
<link rel="stylesheet" href="/css/highlight/dark.min.css" media="(prefers-color-scheme: dark)">

    </body>
</html>
